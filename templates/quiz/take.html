{% extends "base.html" %}

{% block title %}{{ quiz.title }} - MyZenBrain{% endblock %}

{% block content %}
<div class="fade-in" style="max-width: 700px; margin: 0 auto;">
    <h1 class="mb-2">{{ quiz.title }}</h1>
    <p class="text-muted mb-4">{{ quiz.description }}</p>

    <div id="quiz-container">
        <form id="quiz-form">
            {% for q in questions %}
            <div class="card quiz-question mb-3" data-id="{{ q.id }}">
                <h3>Question {{ loop.index }}</h3>
                <p class="mb-3">{{ q.question_text }}</p>

                {% if q.question_type == 'multiple_choice' %}
                <div class="quiz-options">
                    {% for opt in q.options_list %}
                    <label class="quiz-option">
                        <input type="radio" name="q_{{ q.id }}" value="{{ opt }}">
                        <span>{{ opt }}</span>
                    </label>
                    {% endfor %}
                </div>

                {% elif q.question_type == 'true_false' %}
                <div class="quiz-options">
                    <label class="quiz-option">
                        <input type="radio" name="q_{{ q.id }}" value="true">
                        <span>True</span>
                    </label>
                    <label class="quiz-option">
                        <input type="radio" name="q_{{ q.id }}" value="false">
                        <span>False</span>
                    </label>
                </div>

                {% else %}
                <input type="text" name="q_{{ q.id }}" class="form-control" placeholder="Your answer">
                {% endif %}
            </div>
            {% endfor %}

            <button type="submit" class="btn btn-primary" style="width: 100%;">
                <i class="fas fa-check"></i>
                Submit Quiz
            </button>
        </form>
    </div>

    <!-- Results -->
    <div id="results-container" style="display: none;">
        <div class="card text-center mb-4">
            <h2>Quiz Complete!</h2>
            <div class="stat-value" id="score-display">0%</div>
            <p class="text-muted" id="score-text">0 out of 0 correct</p>
        </div>

        <div id="results-list"></div>

        <div class="flex gap-2 flex-center mt-4">
            <a href="{{ url_for('quiz.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Quizzes
            </a>
            <button class="btn btn-primary" onclick="location.reload()">
                <i class="fas fa-redo"></i>
                Try Again
            </button>
        </div>
    </div>
</div>

<script>
const quizId = {{ quiz.id }};
const startTime = Date.now();

// Style selected options
document.querySelectorAll('.quiz-option').forEach(opt => {
    opt.addEventListener('click', () => {
        const parent = opt.closest('.quiz-options');
        parent.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected'));
        opt.classList.add('selected');
    });
});

document.getElementById('quiz-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const answers = {};

    for (let [key, value] of formData.entries()) {
        const qId = key.replace('q_', '');
        answers[qId] = value;
    }

    const timeTaken = Math.floor((Date.now() - startTime) / 1000);

    const res = await fetch(`/quiz/api/quiz/${quizId}/submit`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ answers, time_taken: timeTaken })
    });

    const result = await res.json();

    // Show results
    document.getElementById('quiz-container').style.display = 'none';
    document.getElementById('results-container').style.display = 'block';

    document.getElementById('score-display').textContent = Math.round(result.percentage) + '%';
    document.getElementById('score-text').textContent = `${result.score} out of ${result.total_points} correct`;

    // Show individual results
    const resultsList = document.getElementById('results-list');
    resultsList.innerHTML = '';

    result.results.forEach((r, i) => {
        const div = document.createElement('div');
        div.className = `card mb-2 ${r.correct ? 'quiz-option correct' : 'quiz-option incorrect'}`;
        div.innerHTML = `
            <strong>Q${i + 1}:</strong> ${r.correct ? '<i class="fas fa-check" style="color: var(--success);"></i>' : '<i class="fas fa-times" style="color: var(--error);"></i>'}
            <br>
            <span class="text-muted">Your answer: ${r.user_answer || '(no answer)'}</span>
            ${!r.correct ? `<br><span style="color: var(--success);">Correct: ${r.correct_answer}</span>` : ''}
            ${r.explanation ? `<br><small class="text-muted"><em>${r.explanation}</em></small>` : ''}
        `;
        resultsList.appendChild(div);
    });
});
</script>
{% endblock %}
